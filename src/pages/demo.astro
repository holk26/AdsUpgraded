---
import Layout from '../layouts/Layout.astro';
---

<Layout 
  title="LeadFlow Engine - Interactive Demo"
  description="Interactive mind map showing the flow from Facebook to Core to Dashboard"
>
  <div class="min-h-screen bg-bg-surface py-12 px-4">
    <div class="max-w-6xl mx-auto">
      
      <!-- Header -->
      <header class="text-center mb-12">
        <h1 class="font-heading text-text-heading mb-4">LeadFlow Engine Interactive Demo</h1>
        <p class="text-text-body text-lg max-w-2xl mx-auto">
          Watch how leads flow from multiple channels through automated processing to Twenty CRM
        </p>
        <button id="start-animation" class="mt-4 px-6 py-3 bg-color-accent text-white rounded-saas font-semibold hover:opacity-90 transition-all shadow-lg">
          ‚ñ∂ Start Flow Animation
        </button>
      </header>

      <!-- Interactive Mind Map Container -->
      <div class="bg-white rounded-saas shadow-lg border border-brand-border p-8 relative overflow-hidden">
        <svg id="mindmap" class="w-full" style="min-height: 700px;" viewBox="0 0 1200 700" preserveAspectRatio="xMidYMid meet">
          <defs>
            <!-- Gradient for connections -->
            <linearGradient id="connectionGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:var(--color-accent);stop-opacity:1" />
              <stop offset="100%" style="stop-color:var(--color-secondary);stop-opacity:1" />
            </linearGradient>
            
            <!-- Animated gradient for active state -->
            <linearGradient id="activeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:var(--color-accent);stop-opacity:1">
                <animate attributeName="offset" values="0;1;0" dur="2s" repeatCount="indefinite" />
              </stop>
              <stop offset="50%" style="stop-color:var(--color-secondary);stop-opacity:1">
                <animate attributeName="offset" values="0.5;1;0.5" dur="2s" repeatCount="indefinite" />
              </stop>
              <stop offset="100%" style="stop-color:var(--color-primary);stop-opacity:1">
                <animate attributeName="offset" values="1;0;1" dur="2s" repeatCount="indefinite" />
              </stop>
            </linearGradient>

            <!-- Drop shadow filter -->
            <filter id="dropShadow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
              <feOffset dx="0" dy="2" result="offsetblur"/>
              <feComponentTransfer>
                <feFuncA type="linear" slope="0.3"/>
              </feComponentTransfer>
              <feMerge>
                <feMergeNode/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>

            <!-- Glow filter for light signals -->
            <filter id="glow">
              <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>

          <!-- Connection Lines -->
          <g id="connections">
            <!-- Lead Sources to Core -->
            <path id="line-fb-core" d="M 150 200 L 420 350" stroke="url(#connectionGradient)" stroke-width="4" fill="none" stroke-dasharray="10 5" class="connection-line">
              <animate attributeName="stroke-dashoffset" from="15" to="0" dur="1s" repeatCount="indefinite" />
            </path>
            <path id="line-ig-core" d="M 150 350 L 420 350" stroke="url(#connectionGradient)" stroke-width="4" fill="none" stroke-dasharray="10 5" class="connection-line">
              <animate attributeName="stroke-dashoffset" from="15" to="0" dur="1s" repeatCount="indefinite" />
            </path>
            <path id="line-google-core" d="M 150 500 L 420 350" stroke="url(#connectionGradient)" stroke-width="4" fill="none" stroke-dasharray="10 5" class="connection-line">
              <animate attributeName="stroke-dashoffset" from="15" to="0" dur="1s" repeatCount="indefinite" />
            </path>
            
            <!-- Core to CRM (main flow) -->
            <path id="line-core-crm" d="M 580 350 L 920 350" stroke="url(#connectionGradient)" stroke-width="6" fill="none" stroke-dasharray="12 6" class="connection-line">
              <animate attributeName="stroke-dashoffset" from="18" to="0" dur="1.2s" repeatCount="indefinite" />
            </path>
            
            <!-- Core to Email System (parallel processing) -->
            <path id="line-core-email" d="M 500 410 L 650 530" stroke="url(#connectionGradient)" stroke-width="4" fill="none" stroke-dasharray="8 4" class="connection-line">
              <animate attributeName="stroke-dashoffset" from="12" to="0" dur="1s" repeatCount="indefinite" />
            </path>
            
            <!-- Email to CRM -->
            <path id="line-email-crm" d="M 710 580 L 970 430" stroke="url(#connectionGradient)" stroke-width="3" fill="none" stroke-dasharray="8 4" class="connection-line" opacity="0.8">
              <animate attributeName="stroke-dashoffset" from="12" to="0" dur="1.2s" repeatCount="indefinite" />
            </path>
            
            <!-- Core to Sales Agents (parallel processing) -->
            <path id="line-core-agents" d="M 500 290 L 650 170" stroke="url(#connectionGradient)" stroke-width="4" fill="none" stroke-dasharray="8 4" class="connection-line">
              <animate attributeName="stroke-dashoffset" from="12" to="0" dur="1s" repeatCount="indefinite" />
            </path>
            
            <!-- Sales Agents to CRM -->
            <path id="line-agents-crm" d="M 710 120 L 970 270" stroke="url(#connectionGradient)" stroke-width="3" fill="none" stroke-dasharray="8 4" class="connection-line" opacity="0.8">
              <animate attributeName="stroke-dashoffset" from="12" to="0" dur="1.2s" repeatCount="indefinite" />
            </path>
          </g>

          <!-- Light Signal Particles (hidden by default) -->
          <g id="light-signals"></g>

          <!-- Nodes -->
          <!-- Lead Source Nodes (Left Side) -->
          
          <!-- Facebook Node -->
          <g id="node-facebook" class="node source-node" data-node="facebook" data-channel="facebook" style="cursor: pointer;">
            <circle cx="100" cy="200" r="50" fill="#1877F2" filter="url(#dropShadow)" class="node-circle"/>
            <circle cx="100" cy="200" r="53" fill="none" stroke="#1877F2" stroke-width="2" opacity="0.3" class="node-ring">
              <animate attributeName="r" values="53;58;53" dur="2s" repeatCount="indefinite" />
              <animate attributeName="opacity" values="0.3;0;0.3" dur="2s" repeatCount="indefinite" />
            </circle>
            <text x="100" y="215" text-anchor="middle" fill="white" font-size="36" font-weight="bold">f</text>
            <text x="100" y="270" text-anchor="middle" fill="var(--text-heading)" font-size="14" font-weight="600">Facebook</text>
          </g>

          <!-- Instagram Node -->
          <g id="node-instagram" class="node source-node" data-node="instagram" data-channel="instagram" style="cursor: pointer;">
            <circle cx="100" cy="350" r="50" fill="#E4405F" filter="url(#dropShadow)" class="node-circle"/>
            <circle cx="100" cy="350" r="53" fill="none" stroke="#E4405F" stroke-width="2" opacity="0.3" class="node-ring">
              <animate attributeName="r" values="53;58;53" dur="2s" repeatCount="indefinite" />
              <animate attributeName="opacity" values="0.3;0;0.3" dur="2s" repeatCount="indefinite" />
            </circle>
            <!-- Instagram Camera Icon -->
            <g transform="translate(100, 350)">
              <rect x="-18" y="-15" width="36" height="30" rx="8" fill="none" stroke="white" stroke-width="3"/>
              <circle cx="0" cy="0" r="10" fill="none" stroke="white" stroke-width="3"/>
              <circle cx="10" cy="-10" r="2" fill="white"/>
            </g>
            <text x="100" y="420" text-anchor="middle" fill="var(--text-heading)" font-size="14" font-weight="600">Instagram</text>
          </g>

          <!-- Google Ads Node -->
          <g id="node-google" class="node source-node" data-node="google" data-channel="google" style="cursor: pointer;">
            <circle cx="100" cy="500" r="50" fill="#4285F4" filter="url(#dropShadow)" class="node-circle"/>
            <circle cx="100" cy="500" r="53" fill="none" stroke="#4285F4" stroke-width="2" opacity="0.3" class="node-ring">
              <animate attributeName="r" values="53;58;53" dur="2s" repeatCount="indefinite" />
              <animate attributeName="opacity" values="0.3;0;0.3" dur="2s" repeatCount="indefinite" />
            </circle>
            <text x="100" y="515" text-anchor="middle" fill="white" font-size="32" font-weight="bold">G</text>
            <text x="100" y="570" text-anchor="middle" fill="var(--text-heading)" font-size="14" font-weight="600">Google Ads</text>
          </g>

          <!-- Core Node (Central Hub) -->
          <g id="node-core" class="node" data-node="core" style="cursor: pointer;">
            <circle cx="500" cy="350" r="80" fill="var(--color-primary)" filter="url(#dropShadow)" class="node-circle"/>
            <circle cx="500" cy="350" r="84" fill="none" stroke="var(--color-accent)" stroke-width="2" opacity="0.3" class="node-ring">
              <animate attributeName="r" values="84;90;84" dur="2s" repeatCount="indefinite" />
              <animate attributeName="opacity" values="0.3;0;0.3" dur="2s" repeatCount="indefinite" />
            </circle>
            <!-- Core Icon (Gear/Cog) -->
            <g transform="translate(500, 350)">
              <path d="M 0,-30 L 5,-35 L 10,-30 L 10,-20 L 5,-15 L 0,-20 Z M 21,-21 L 28,-23 L 32,-18 L 28,-10 L 21,-8 L 18,-13 Z M 21,21 L 23,28 L 18,32 L 10,28 L 8,21 L 13,18 Z M -21,21 L -28,23 L -32,18 L -28,10 L -21,8 L -18,13 Z M -21,-21 L -23,-28 L -18,-32 L -10,-28 L -8,-21 L -13,-18 Z" 
                    fill="white" opacity="0.3"/>
              <circle cx="0" cy="0" r="15" fill="none" stroke="white" stroke-width="3"/>
              <circle cx="0" cy="0" r="8" fill="white"/>
            </g>
            <text x="500" y="450" text-anchor="middle" fill="var(--text-heading)" font-size="16" font-weight="600">Core Engine</text>
            <text x="500" y="470" text-anchor="middle" fill="var(--text-body)" font-size="13">Processing Hub</text>
          </g>

          <!-- Twenty CRM Node (larger, more prominent) -->
          <g id="node-crm" class="node" data-node="crm" style="cursor: pointer;">
            <circle cx="1000" cy="350" r="80" fill="#8B5CF6" filter="url(#dropShadow)" class="node-circle"/>
            <circle cx="1000" cy="350" r="84" fill="none" stroke="#8B5CF6" stroke-width="3" opacity="0.4" class="node-ring">
              <animate attributeName="r" values="84;92;84" dur="2s" repeatCount="indefinite" />
              <animate attributeName="opacity" values="0.4;0;0.4" dur="2s" repeatCount="indefinite" />
            </circle>
            <!-- CRM Icon (Database/People) with Dashboard integrated -->
            <g transform="translate(1000, 350)">
              <circle cx="-10" cy="-12" r="9" fill="none" stroke="white" stroke-width="3"/>
              <path d="M -10,-3 Q -10,6 -18,10 L -18,17 Q -10,13 -10,23 M -10,23 Q -10,13 -2,17 L -2,10 Q -10,6 -10,-3" fill="none" stroke="white" stroke-width="3"/>
              <circle cx="10" cy="-12" r="9" fill="none" stroke="white" stroke-width="3"/>
              <path d="M 10,-3 Q 10,6 2,10 L 2,17 Q 10,13 10,23 M 10,23 Q 10,13 18,17 L 18,10 Q 10,6 10,-3" fill="none" stroke="white" stroke-width="3"/>
              <!-- Dashboard chart icon integrated -->
              <rect x="-15" y="0" width="6" height="15" fill="white" opacity="0.5" rx="1"/>
              <rect x="-5" y="-5" width="6" height="20" fill="white" opacity="0.5" rx="1"/>
              <rect x="5" y="3" width="6" height="12" fill="white" opacity="0.5" rx="1"/>
            </g>
            <text x="1000" y="445" text-anchor="middle" fill="var(--text-heading)" font-size="18" font-weight="700">Twenty CRM</text>
            <text x="1000" y="465" text-anchor="middle" fill="var(--text-body)" font-size="14">CRM + Dashboard</text>
          </g>

          <!-- Email System Node (Bottom Right) -->
          <g id="node-email" class="node" data-node="email" style="cursor: pointer;">
            <circle cx="680" cy="580" r="55" fill="#EA4335" filter="url(#dropShadow)" class="node-circle"/>
            <circle cx="680" cy="580" r="58" fill="none" stroke="#EA4335" stroke-width="2" opacity="0.3" class="node-ring">
              <animate attributeName="r" values="58;64;58" dur="2s" repeatCount="indefinite" />
              <animate attributeName="opacity" values="0.3;0;0.3" dur="2s" repeatCount="indefinite" />
            </circle>
            <!-- Email Icon (Envelope) -->
            <g transform="translate(680, 580)">
              <rect x="-22" y="-14" width="44" height="28" rx="3" fill="none" stroke="white" stroke-width="3"/>
              <path d="M -22,-14 L 0,4 L 22,-14" fill="none" stroke="white" stroke-width="3"/>
            </g>
            <text x="680" y="655" text-anchor="middle" fill="var(--text-heading)" font-size="15" font-weight="600">Email Automation</text>
          </g>

          <!-- Sales Agents Node (Top Right) -->
          <g id="node-agents" class="node" data-node="agents" style="cursor: pointer;">
            <circle cx="680" cy="120" r="55" fill="#FF6B6B" filter="url(#dropShadow)" class="node-circle"/>
            <circle cx="680" cy="120" r="58" fill="none" stroke="#FF6B6B" stroke-width="2" opacity="0.3" class="node-ring">
              <animate attributeName="r" values="58;64;58" dur="2s" repeatCount="indefinite" />
              <animate attributeName="opacity" values="0.3;0;0.3" dur="2s" repeatCount="indefinite" />
            </circle>
            <!-- Sales Agents Icon (People) -->
            <g transform="translate(680, 120)">
              <circle cx="-12" cy="-6" r="7" fill="none" stroke="white" stroke-width="2.5"/>
              <path d="M -12,2 Q -12,9 -19,11 L -19,16 Q -12,13 -12,20 M -12,20 Q -12,13 -5,16 L -5,11 Q -12,9 -12,2" fill="none" stroke="white" stroke-width="2.5"/>
              <circle cx="12" cy="-6" r="7" fill="none" stroke="white" stroke-width="2.5"/>
              <path d="M 12,2 Q 12,9 5,11 L 5,16 Q 12,13 12,20 M 12,20 Q 12,13 19,16 L 19,11 Q 12,9 12,2" fill="none" stroke="white" stroke-width="2.5"/>
            </g>
            <text x="680" y="65" text-anchor="middle" fill="var(--text-heading)" font-size="15" font-weight="600">Sales Assignment</text>
          </g>
        </svg>

        <!-- Simulated Lead Form Modal -->
        <div id="lead-form-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div class="bg-white rounded-saas shadow-xl p-6 md:p-8 max-w-md w-full max-h-[90vh] overflow-y-auto relative">
            <button id="close-modal" class="absolute top-4 right-4 text-text-muted hover:text-text-heading text-2xl z-10">√ó</button>
            <h3 class="font-heading text-text-heading text-xl md:text-2xl mb-3">Lead Capture Form</h3>
            <p class="text-text-body mb-4 text-sm md:text-base">Simulated form from <span id="form-source" class="font-semibold text-color-accent"></span></p>
            <form id="demo-form" class="space-y-3 md:space-y-4">
              <div>
                <label class="block text-text-heading font-medium mb-1 text-sm md:text-base">Name *</label>
                <input type="text" value="Sarah Chen" class="w-full px-3 py-2 border border-brand-border rounded-saas focus:outline-none focus:ring-2 focus:ring-color-accent text-sm md:text-base" required />
              </div>
              <div>
                <label class="block text-text-heading font-medium mb-1 text-sm md:text-base">Email *</label>
                <input type="email" value="sarah.chen@example.com" class="w-full px-3 py-2 border border-brand-border rounded-saas focus:outline-none focus:ring-2 focus:ring-color-accent text-sm md:text-base" required />
              </div>
              <div>
                <label class="block text-text-heading font-medium mb-1 text-sm md:text-base">Phone</label>
                <input type="tel" value="+1 (604) 555-0123" class="w-full px-3 py-2 border border-brand-border rounded-saas focus:outline-none focus:ring-2 focus:ring-color-accent text-sm md:text-base" />
              </div>
              <div>
                <label class="block text-text-heading font-medium mb-1 text-sm md:text-base">Company</label>
                <input type="text" value="Vancouver Home Renovations" class="w-full px-3 py-2 border border-brand-border rounded-saas focus:outline-none focus:ring-2 focus:ring-color-accent text-sm md:text-base" />
              </div>
              <div>
                <label class="block text-text-heading font-medium mb-1 text-sm md:text-base">Service Interest</label>
                <select class="w-full px-3 py-2 border border-brand-border rounded-saas focus:outline-none focus:ring-2 focus:ring-color-accent text-sm md:text-base">
                  <option value="kitchen">Kitchen Renovation</option>
                  <option value="bathroom">Bathroom Remodel</option>
                  <option value="landscaping">Landscaping</option>
                  <option value="roofing">Roofing</option>
                  <option value="general">General Inquiry</option>
                </select>
              </div>
              <div>
                <label class="block text-text-heading font-medium mb-1 text-sm md:text-base">Budget Range</label>
                <select class="w-full px-3 py-2 border border-brand-border rounded-saas focus:outline-none focus:ring-2 focus:ring-color-accent text-sm md:text-base">
                  <option value="5-10k">$5,000 - $10,000 CAD</option>
                  <option value="10-25k">$10,000 - $25,000 CAD</option>
                  <option value="25-50k" selected>$25,000 - $50,000 CAD</option>
                  <option value="50k+">$50,000+ CAD</option>
                </select>
              </div>
              <div>
                <label class="block text-text-heading font-medium mb-1 text-sm md:text-base">Message</label>
                <textarea rows="3" class="w-full px-3 py-2 border border-brand-border rounded-saas focus:outline-none focus:ring-2 focus:ring-color-accent text-sm md:text-base">Looking to renovate our kitchen in North Vancouver. Interested in getting a quote for a modern design with quartz countertops.</textarea>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="newsletter" checked class="mr-2 h-4 w-4 text-color-accent rounded focus:ring-2 focus:ring-color-accent flex-shrink-0" />
                <label for="newsletter" class="text-text-body text-xs md:text-sm">Send me updates and promotional offers</label>
              </div>
              <button type="submit" class="w-full px-4 py-3 md:px-6 md:py-4 bg-color-accent text-white rounded-saas font-semibold hover:opacity-90 transition-all shadow-lg text-sm md:text-base mt-2">
                Submit Lead ‚Üí
              </button>
            </form>
          </div>
        </div>

        <!-- Info Panel -->
        <div id="info-panel" class="mt-8 p-6 bg-bg-surface rounded-saas border border-brand-border">
          <h3 class="font-heading text-text-heading text-xl mb-4">üéØ Streamlined Architecture ‚Ä¢ Click nodes to explore</h3>
          <div id="node-info" class="text-text-body">
            <p class="mb-3"><strong>Simplified LeadFlow:</strong> Direct path from lead capture to CRM with intelligent automation.</p>
            <ul class="list-disc list-inside space-y-2">
              <li><strong>Lead Sources ‚Üí</strong> Capture from Facebook, Instagram, Google Ads</li>
              <li><strong>Core Engine ‚Üí</strong> Process, normalize, and route to CRM + parallel services</li>
              <li><strong>Email Automation ‚Üí</strong> Instant notifications and follow-up sequences</li>
              <li><strong>Sales Assignment ‚Üí</strong> Intelligent routing to available sales agents</li>
              <li><strong>Twenty CRM ‚Üí</strong> Unified CRM + Dashboard for complete lead management</li>
            </ul>
          </div>
        </div>
      </div>

    </div>
  </div>

  <style>
    .node {
      transition: all 0.3s ease;
    }

    .node:hover .node-circle {
      filter: url(#dropShadow) brightness(1.1);
    }

    .node:hover .node-ring {
      stroke-width: 3;
      opacity: 0.6 !important;
    }

    .connection-line {
      transition: stroke-width 0.3s ease;
    }

    .node.active .node-circle {
      filter: url(#dropShadow) brightness(1.2);
    }

    .node.active .node-ring {
      stroke-width: 4;
    }

    #info-panel {
      animation: fadeIn 0.5s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Modal styles */
    #lead-form-modal.show {
      display: flex !important;
      animation: modalFadeIn 0.3s ease;
    }

    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Light signal animation */
    .light-signal {
      filter: url(#glow);
      animation: pulse 0.8s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 1; }
    }
  </style>

  <script>
    // Interactive functionality
    const nodes = document.querySelectorAll('.node');
    const sourceNodes = document.querySelectorAll('.source-node');
    const infoPanel = document.getElementById('node-info');
    const modal = document.getElementById('lead-form-modal');
    const closeModal = document.getElementById('close-modal');
    const formSource = document.getElementById('form-source');
    const demoForm = document.getElementById('demo-form');
    const startAnimationBtn = document.getElementById('start-animation');
    const lightSignalsGroup = document.getElementById('light-signals');

    const nodeInfo = {
      facebook: {
        title: 'Facebook Lead Capture',
        description: 'Capture leads directly from your Facebook campaigns with full UTM tracking.',
        features: [
          'Automatic lead capture from Facebook Ads',
          'Complete UTM parameter tracking',
          'Real-time lead notification',
          'Instagram integration included',
          'Track campaign performance',
          'Form simulation available'
        ]
      },
      instagram: {
        title: 'Instagram Lead Capture',
        description: 'Convert Instagram engagement into qualified leads.',
        features: [
          'Instagram Stories and Posts ads',
          'Direct message lead capture',
          'Visual content tracking',
          'Influencer campaign tracking',
          'Engagement metrics',
          'Form simulation available'
        ]
      },
      google: {
        title: 'Google Ads Lead Capture',
        description: 'Capture high-intent leads from Google Search and Display ads.',
        features: [
          'Search and Display ad tracking',
          'Keyword-level attribution',
          'Landing page optimization',
          'Quality Score monitoring',
          'Conversion tracking',
          'Form simulation available'
        ]
      },
      core: {
        title: 'Core Processing Engine',
        description: 'The heart of LeadFlow Engine - where all the magic happens.',
        features: [
          'Instant data normalization and cleaning',
          'Automatic lead enrichment',
          'Duplicate detection and merging',
          'Smart routing to appropriate teams',
          'Real-time CRM synchronization',
          'Advanced UTM attribution'
        ]
      },
      crm: {
        title: 'Twenty CRM + Dashboard',
        description: 'Unified CRM and analytics platform for complete lead management.',
        features: [
          'Real-time lead synchronization',
          'Built-in analytics dashboard',
          'Custom field mapping',
          'Automated workflow triggers',
          'Lead scoring and qualification',
          'ROI tracking and reporting',
          'Team collaboration tools',
          'Activity timeline tracking',
          'Campaign performance metrics'
        ]
      },
      email: {
        title: 'Email Automation System',
        description: 'Automated email notifications and follow-up campaigns for leads.',
        features: [
          'Instant lead notification emails',
          'Automated welcome sequences',
          'Follow-up email campaigns',
          'Personalized email templates',
          'Email open and click tracking',
          'A/B testing capabilities',
          'Integration with marketing automation'
        ]
      },
      agents: {
        title: 'Sales Agent Assignment',
        description: 'Intelligent lead routing and assignment to your sales team.',
        features: [
          'Smart lead distribution',
          'Round-robin assignment',
          'Territory-based routing',
          'Agent performance tracking',
          'Lead notification system',
          'Workload balancing',
          'Priority lead identification'
        ]
      }
    };

    // Handle source node clicks (show form modal)
    sourceNodes.forEach(node => {
      node.addEventListener('click', function(e) {
        e.preventDefault();
        const channel = this.getAttribute('data-channel');
        const channelNames = {
          facebook: 'Facebook',
          instagram: 'Instagram',
          google: 'Google Ads'
        };
        if (formSource) {
          formSource.textContent = channelNames[channel] || channel;
        }
        modal?.classList.add('show');
      });
    });

    // Close modal
    closeModal?.addEventListener('click', () => {
      modal?.classList.remove('show');
    });

    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('show');
      }
    });

    // Handle form submission
    demoForm?.addEventListener('submit', (e) => {
      e.preventDefault();
      modal?.classList.remove('show');
      
      // Get lead name from form
      const nameInput = (e.target as HTMLFormElement).querySelector('input[type="text"]') as HTMLInputElement;
      const leadName = nameInput?.value || 'Lead';
      
      // Start flow animation
      startFlowAnimation();
      
      // Show success message with processing steps
      if (infoPanel) {
        infoPanel.innerHTML = `
          <h3 class="font-heading text-text-heading text-xl mb-3">‚úÖ Lead Captured Successfully!</h3>
          <p class="text-text-body mb-4"><strong>Lead:</strong> ${leadName} ‚Ä¢ Watch the light signals travel through the system</p>
          <div class="space-y-3">
            <div class="flex items-start">
              <span class="mr-2">‚öôÔ∏è</span>
              <div>
                <strong class="text-text-heading">Core Processing:</strong>
                <p class="text-sm text-text-body">Normalizing data, enriching lead info, checking for duplicates</p>
              </div>
            </div>
            <div class="flex items-start">
              <span class="mr-2">üìä</span>
              <div>
                <strong class="text-text-heading">Dashboard Update:</strong>
                <p class="text-sm text-text-body">Adding to analytics, updating ROI metrics, tracking source attribution</p>
              </div>
            </div>
            <div class="flex items-start">
              <span class="mr-2">üíæ</span>
              <div>
                <strong class="text-text-heading">CRM Sync:</strong>
                <p class="text-sm text-text-body">Syncing to Twenty CRM, creating contact record, assigning to pipeline</p>
              </div>
            </div>
            <div class="flex items-start">
              <span class="mr-2">üìß</span>
              <div>
                <strong class="text-text-heading">Email Notification:</strong>
                <p class="text-sm text-text-body">Sending welcome email, notifying sales team, queuing follow-up sequence</p>
              </div>
            </div>
            <div class="flex items-start">
              <span class="mr-2">üë•</span>
              <div>
                <strong class="text-text-heading">Agent Assignment:</strong>
                <p class="text-sm text-text-body">Routing to available sales agent, notifying assigned agent, updating queue</p>
              </div>
            </div>
          </div>
        `;
      }
    });

    // Handle non-source node clicks (show info)
    nodes.forEach(node => {
      if (!node.classList.contains('source-node')) {
        node.addEventListener('click', function(e) {
          e.preventDefault();
          
          // Remove active class from all nodes
          nodes.forEach(n => n.classList.remove('active'));
          
          // Add active class to clicked node
          this.classList.add('active');
          
          // Update info panel
          const nodeType = this.getAttribute('data-node');
          const info = nodeInfo[nodeType];
          
          if (info && infoPanel) {
            infoPanel.innerHTML = `
              <h3 class="font-heading text-text-heading text-xl mb-3">${info.title}</h3>
              <p class="text-text-body mb-4">${info.description}</p>
              <h4 class="font-heading text-text-heading text-base mb-2">Key Features:</h4>
              <ul class="list-disc list-inside space-y-2 text-text-body">
                ${info.features.map((feature: string) => `<li>${feature}</li>`).join('')}
              </ul>
            `;
          }
        });
      }

      // Add hover effect to connections
      node.addEventListener('mouseenter', function() {
        const nodeType = this.getAttribute('data-node');
        if (nodeType === 'facebook' || nodeType === 'instagram' || nodeType === 'google') {
          document.getElementById('line-fb-core')?.setAttribute('stroke-width', '6');
          document.getElementById('line-ig-core')?.setAttribute('stroke-width', '6');
          document.getElementById('line-google-core')?.setAttribute('stroke-width', '6');
        } else if (nodeType === 'core') {
          document.querySelectorAll('.connection-line').forEach(line => {
            line.setAttribute('stroke-width', '7');
          });
        } else if (nodeType === 'email') {
          document.getElementById('line-core-email')?.setAttribute('stroke-width', '6');
          document.getElementById('line-email-crm')?.setAttribute('stroke-width', '5');
        } else if (nodeType === 'agents') {
          document.getElementById('line-core-agents')?.setAttribute('stroke-width', '6');
          document.getElementById('line-agents-crm')?.setAttribute('stroke-width', '5');
        } else if (nodeType === 'crm') {
          document.getElementById('line-core-crm')?.setAttribute('stroke-width', '8');
          document.getElementById('line-email-crm')?.setAttribute('stroke-width', '5');
          document.getElementById('line-agents-crm')?.setAttribute('stroke-width', '5');
        }
      });

      node.addEventListener('mouseleave', function() {
        // Reset to original widths
        document.getElementById('line-fb-core')?.setAttribute('stroke-width', '4');
        document.getElementById('line-ig-core')?.setAttribute('stroke-width', '4');
        document.getElementById('line-google-core')?.setAttribute('stroke-width', '4');
        document.getElementById('line-core-crm')?.setAttribute('stroke-width', '6');
        document.getElementById('line-core-email')?.setAttribute('stroke-width', '4');
        document.getElementById('line-core-agents')?.setAttribute('stroke-width', '4');
        document.getElementById('line-email-crm')?.setAttribute('stroke-width', '3');
        document.getElementById('line-agents-crm')?.setAttribute('stroke-width', '3');
      });
    });

    // Start animation button
    startAnimationBtn?.addEventListener('click', startFlowAnimation);

    // Flow animation with light signals
    function startFlowAnimation() {
      if (!lightSignalsGroup) return;
      
      // Clear existing signals
      lightSignalsGroup.innerHTML = '';
      
      // Create signals from each source
      const sources = [
        { start: {x: 100, y: 200}, end: {x: 500, y: 350}, delay: 0, color: '#1877F2' },
        { start: {x: 100, y: 350}, end: {x: 500, y: 350}, delay: 400, color: '#E4405F' },
        { start: {x: 100, y: 500}, end: {x: 500, y: 350}, delay: 800, color: '#4285F4' }
      ];
      
      sources.forEach(source => {
        setTimeout(() => {
          createLightSignal(source.start, source.end, source.color, () => {
            // After reaching core, split into three parallel paths
            setTimeout(() => {
              // Path 1: Core to CRM (main flow)
              createLightSignal({x: 500, y: 350}, {x: 1000, y: 350}, '#8B5CF6');
              
              // Path 2: Core to Email System (parallel notification)
              setTimeout(() => {
                createLightSignal({x: 500, y: 350}, {x: 680, y: 580}, '#EA4335', () => {
                  // Email to CRM
                  setTimeout(() => {
                    createLightSignal({x: 680, y: 580}, {x: 1000, y: 350}, '#EA4335');
                  }, 300);
                });
              }, 150);
              
              // Path 3: Core to Sales Agents (parallel assignment)
              setTimeout(() => {
                createLightSignal({x: 500, y: 350}, {x: 680, y: 120}, '#FF6B6B', () => {
                  // Agents to CRM
                  setTimeout(() => {
                    createLightSignal({x: 680, y: 120}, {x: 1000, y: 350}, '#FF6B6B');
                  }, 300);
                });
              }, 300);
            }, 200);
          });
        }, source.delay);
      });
    }

    function createLightSignal(start: {x: number, y: number}, end: {x: number, y: number}, color: string, onComplete?: () => void) {
      if (!lightSignalsGroup) return;
      
      const signal = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
      signal.setAttribute('r', '8');
      signal.setAttribute('fill', color);
      signal.setAttribute('class', 'light-signal');
      signal.setAttribute('cx', start.x.toString());
      signal.setAttribute('cy', start.y.toString());
      
      lightSignalsGroup.appendChild(signal);
      
      // Animate the signal
      const duration = 1500;
      const startTime = Date.now();
      
      function animate() {
        const elapsed = Date.now() - startTime;
        const progress = Math.min(elapsed / duration, 1);
        
        // Easing function
        const eased = 1 - Math.pow(1 - progress, 3);
        
        const currentX = start.x + (end.x - start.x) * eased;
        const currentY = start.y + (end.y - start.y) * eased;
        
        signal.setAttribute('cx', currentX.toString());
        signal.setAttribute('cy', currentY.toString());
        
        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // Remove signal after animation
          setTimeout(() => {
            signal.remove();
            if (onComplete) onComplete();
          }, 100);
        }
      }
      
      requestAnimationFrame(animate);
    }
  </script>
</Layout>
