---
export interface Props {
  lang?: string;
  t: (key: string) => string;
}

const { lang = 'en', t } = Astro.props;

const navItems = [
  { key: 'nav.features', href: '#features', label: t('nav.features') },
  { key: 'nav.pricing', href: '#pricing', label: t('nav.pricing') },
  { key: 'nav.about', href: '#about', label: t('nav.about') },
];
---

<!-- Hamburger Button -->
<button
  id="hamburger-btn"
  class="md:hidden flex items-center justify-center w-10 h-10 rounded-lg hover:bg-white/5 transition-colors focus-visible:outline-2 focus-visible:outline-brand-accent"
  aria-label="Toggle navigation menu"
  aria-expanded="false"
  aria-controls="mobile-menu"
  type="button"
>
  <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
    <path class="hamburger-line hamburger-line-top" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16" />
    <path class="hamburger-line hamburger-line-middle" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12h16" />
    <path class="hamburger-line hamburger-line-bottom" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 18h16" />
  </svg>
</button>

<!-- Fullscreen Mobile Menu -->
<div
  id="mobile-menu"
  class="fixed inset-0 z-[60] pointer-events-none opacity-0"
  aria-hidden="true"
  role="dialog"
  aria-modal="true"
  aria-label="Mobile navigation"
>
  <!-- Backdrop -->
  <div id="menu-backdrop" class="absolute inset-0 bg-black/80 backdrop-blur-xl opacity-0 transition-opacity duration-500"></div>
  
  <!-- Menu Content -->
  <div class="relative h-full flex flex-col items-center justify-center p-8 overflow-hidden">
    <!-- Background Effects -->
    <div class="absolute inset-0 overflow-hidden opacity-30">
      <div class="absolute top-1/4 right-1/4 w-64 h-64 bg-cyan-400/30 rounded-full blur-3xl animate-pulse-slow"></div>
      <div class="absolute bottom-1/4 left-1/4 w-64 h-64 bg-purple-400/30 rounded-full blur-3xl animate-pulse-slow" style="animation-delay: 1s;"></div>
    </div>

    <!-- Close Button -->
    <button
      id="menu-close-btn"
      class="absolute top-6 right-6 w-12 h-12 flex items-center justify-center rounded-full hover:bg-white/10 transition-colors focus-visible:outline-2 focus-visible:outline-brand-accent z-10"
      aria-label="Close navigation menu"
      type="button"
    >
      <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Navigation Links -->
    <nav class="relative z-10 flex flex-col items-center gap-8 w-full max-w-md">
      {navItems.map((item, index) => (
        <a
          href={item.href}
          class="menu-link text-4xl sm:text-5xl font-bold text-white hover:text-cyan-400 transition-all duration-300 opacity-0 transform translate-y-8 focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-cyan-400 rounded-lg px-4"
          data-index={index}
          data-morph-target={`nav-${item.key}`}
        >
          {item.label.split('').map((char: string, charIndex: number) => (
            <span
              class="inline-block letter-morph"
              data-char-index={charIndex}
              style={`animation-delay: ${index * 0.1 + charIndex * 0.02}s`}
            >
              {char === ' ' ? '\u00A0' : char}
            </span>
          ))}
        </a>
      ))}
    </nav>

    <!-- Language & CTA -->
    <div class="relative z-10 mt-12 flex flex-col items-center gap-6 opacity-0 menu-footer">
      <div class="flex gap-4" role="group" aria-label="Language selection">
        <a
          href="/"
          class={`px-6 py-3 rounded-lg text-lg font-medium transition-all ${lang === 'en' ? 'bg-cyan-400 text-black' : 'text-white border border-white/20 hover:border-cyan-400'}`}
          aria-label="Switch to English"
        >
          EN
        </a>
        <a
          href="/es"
          class={`px-6 py-3 rounded-lg text-lg font-medium transition-all ${lang === 'es' ? 'bg-cyan-400 text-black' : 'text-white border border-white/20 hover:border-cyan-400'}`}
          aria-label="Cambiar a EspaÃ±ol"
        >
          ES
        </a>
      </div>
      <a
        href="#demo"
        class="px-8 py-4 bg-gradient-to-r from-cyan-400 to-blue-500 text-black font-bold rounded-lg hover:shadow-lg hover:shadow-cyan-400/50 transition-all duration-300 focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-cyan-400"
      >
        {t('nav.demo')}
      </a>
    </div>
  </div>
</div>

<style>
  /* Hamburger Icon Animation */
  .hamburger-line {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }

  [aria-expanded="true"] .hamburger-line-top {
    transform: translateY(6px) rotate(45deg);
  }

  [aria-expanded="true"] .hamburger-line-middle {
    opacity: 0;
    transform: scaleX(0);
  }

  [aria-expanded="true"] .hamburger-line-bottom {
    transform: translateY(-6px) rotate(-45deg);
  }

  /* Letter Morphing Animation */
  @keyframes letter-morph-in {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.8) rotate(-5deg);
      filter: blur(4px);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1) rotate(0deg);
      filter: blur(0);
    }
  }

  .menu-link.active .letter-morph {
    animation: letter-morph-in 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  /* Menu Link Hover Effect */
  .menu-link {
    position: relative;
    text-shadow: 0 0 20px rgba(0, 255, 194, 0);
    transition: text-shadow 0.3s ease;
  }

  .menu-link:hover {
    text-shadow: 0 0 20px rgba(0, 255, 194, 0.6);
  }

  .menu-link::after {
    content: '';
    position: absolute;
    left: 0;
    bottom: -4px;
    width: 0;
    height: 3px;
    background: linear-gradient(90deg, #00FFC2, #5D5DFF);
    transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .menu-link:hover::after {
    width: 100%;
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .hamburger-line,
    .menu-link,
    .letter-morph {
      animation: none !important;
      transition: none !important;
    }

    #menu-backdrop {
      transition: opacity 0.2s ease;
    }
  }
</style>

<script>
  // Hamburger Menu Animation with FLIP technique
  class HamburgerMenu {
    private isOpen = false;
    private menuEl: HTMLElement;
    private backdropEl: HTMLElement;
    private hamburgerBtn: HTMLButtonElement;
    private closeBtn: HTMLButtonElement;
    private menuLinks: NodeListOf<HTMLAnchorElement>;
    private menuFooter: HTMLElement;
    private focusableElements: HTMLElement[] = [];
    private lastFocusedElement: HTMLElement | null = null;
    private prefersReducedMotion: boolean;

    constructor() {
      this.menuEl = document.getElementById('mobile-menu') as HTMLElement;
      this.backdropEl = document.getElementById('menu-backdrop') as HTMLElement;
      this.hamburgerBtn = document.getElementById('hamburger-btn') as HTMLButtonElement;
      this.closeBtn = document.getElementById('menu-close-btn') as HTMLButtonElement;
      this.menuLinks = document.querySelectorAll('.menu-link');
      this.menuFooter = document.querySelector('.menu-footer') as HTMLElement;
      this.prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      this.init();
    }

    private init() {
      // Event listeners
      this.hamburgerBtn.addEventListener('click', () => this.toggle());
      this.closeBtn.addEventListener('click', () => this.close());
      this.backdropEl.addEventListener('click', () => this.close());
      
      // Close on navigation
      this.menuLinks.forEach(link => {
        link.addEventListener('click', () => {
          setTimeout(() => this.close(), 300);
        });
      });

      // Keyboard navigation
      document.addEventListener('keydown', (e) => this.handleKeyDown(e));

      // Update focusable elements
      this.updateFocusableElements();

      // Listen for reduced motion changes
      const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
      motionQuery.addEventListener('change', (e) => {
        this.prefersReducedMotion = e.matches;
      });
    }

    private updateFocusableElements() {
      const selectors = 'a[href], button:not([disabled]), [tabindex]:not([tabindex="-1"])';
      this.focusableElements = Array.from(
        this.menuEl.querySelectorAll(selectors)
      ) as HTMLElement[];
    }

    private async toggle() {
      if (this.isOpen) {
        await this.close();
      } else {
        await this.open();
      }
    }

    private async open() {
      this.isOpen = true;
      this.lastFocusedElement = document.activeElement as HTMLElement;

      // Update ARIA
      this.hamburgerBtn.setAttribute('aria-expanded', 'true');
      this.menuEl.setAttribute('aria-hidden', 'false');
      
      // Enable pointer events and show menu
      this.menuEl.classList.remove('pointer-events-none', 'opacity-0');
      this.menuEl.classList.add('pointer-events-auto', 'opacity-100');

      // Animate backdrop
      requestAnimationFrame(() => {
        this.backdropEl.style.opacity = '1';
      });

      // Prevent body scroll
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';

      // Animate menu items with stagger
      if (!this.prefersReducedMotion) {
        this.menuLinks.forEach((link, index) => {
          setTimeout(() => {
            link.classList.add('active');
            link.style.opacity = '1';
            link.style.transform = 'translateY(0)';
          }, index * 100);
        });

        // Animate footer
        setTimeout(() => {
          this.menuFooter.style.opacity = '1';
          this.menuFooter.style.transform = 'translateY(0)';
        }, this.menuLinks.length * 100);
      } else {
        // Instant for reduced motion
        this.menuLinks.forEach(link => {
          link.classList.add('active');
          link.style.opacity = '1';
          link.style.transform = 'none';
        });
        this.menuFooter.style.opacity = '1';
        this.menuFooter.style.transform = 'none';
      }

      // Focus first link
      setTimeout(() => {
        this.closeBtn.focus();
      }, 100);
    }

    private async close() {
      if (!this.isOpen) return;
      
      this.isOpen = false;

      // Update ARIA
      this.hamburgerBtn.setAttribute('aria-expanded', 'false');
      this.menuEl.setAttribute('aria-hidden', 'true');

      // Animate out
      this.backdropEl.style.opacity = '0';
      
      if (!this.prefersReducedMotion) {
        // Reverse animation
        this.menuLinks.forEach((link, index) => {
          setTimeout(() => {
            link.style.opacity = '0';
            link.style.transform = 'translateY(20px)';
            link.classList.remove('active');
          }, index * 50);
        });

        this.menuFooter.style.opacity = '0';
        this.menuFooter.style.transform = 'translateY(20px)';
      } else {
        this.menuLinks.forEach(link => {
          link.style.opacity = '0';
          link.classList.remove('active');
        });
        this.menuFooter.style.opacity = '0';
      }

      // Wait for animation to complete
      const duration = this.prefersReducedMotion ? 200 : 500;
      await new Promise(resolve => setTimeout(resolve, duration));

      // Hide menu
      this.menuEl.classList.add('pointer-events-none', 'opacity-0');
      this.menuEl.classList.remove('pointer-events-auto', 'opacity-100');

      // Restore body scroll
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.width = '';

      // Restore focus
      if (this.lastFocusedElement) {
        this.lastFocusedElement.focus();
      }
    }

    private handleKeyDown(e: KeyboardEvent) {
      if (!this.isOpen) return;

      if (e.key === 'Escape') {
        e.preventDefault();
        this.close();
        return;
      }

      // Tab trap
      if (e.key === 'Tab') {
        const firstElement = this.focusableElements[0];
        const lastElement = this.focusableElements[this.focusableElements.length - 1];

        if (e.shiftKey && document.activeElement === firstElement) {
          e.preventDefault();
          lastElement?.focus();
        } else if (!e.shiftKey && document.activeElement === lastElement) {
          e.preventDefault();
          firstElement?.focus();
        }
      }
    }
  }

  // Initialize on load
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      new HamburgerMenu();
    });
  }
</script>
