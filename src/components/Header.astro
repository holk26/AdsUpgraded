---
import Button from './ui/Button.astro';

export interface Props {
  lang?: string;
  t: (key: string) => string;
}

const { lang = 'en', t } = Astro.props;

const navItems = [
  { key: 'nav.features', href: '#features' },
  { key: 'nav.pricing', href: '#pricing' },
  { key: 'nav.about', href: '#about' },
];
---

<header class="fixed top-0 left-0 right-0 z-50 glass-effect border-b border-white/5 shadow-lg">
  <div class="container mx-auto px-4">
    <nav class="flex items-center justify-between py-3 md:py-4 gap-2 md:gap-4" aria-label="Main navigation">
      <!-- Logo -->
      <a href="/" class="flex items-center gap-2 group focus-visible:outline-2 focus-visible:outline-brand-accent rounded-lg flex-shrink-0">
        <svg class="w-7 h-7 md:w-8 md:h-8 transition-transform group-hover:scale-110" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <defs>
            <filter id="glowIndigo" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
            <filter id="glowCyan" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
              <feMerge>
                <feMergeNode in="coloredBlur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
            <radialGradient id="indigoGrad" cx="50%" cy="50%">
              <stop offset="0%" style="stop-color:#7B7BFF;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#5D5DFF;stop-opacity:0.8" />
            </radialGradient>
            <radialGradient id="cyanGrad" cx="50%" cy="50%">
              <stop offset="0%" style="stop-color:#00FFDB;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#00FFC2;stop-opacity:0.7" />
            </radialGradient>
          </defs>
          
          <!-- Hexagons with fill and glow -->
          <g filter="url(#glowIndigo)">
            <path d="M60 8 L68 13 L68 23 L60 28 L52 23 L52 13 Z" fill="url(#indigoGrad)" opacity="0.85"/>
          </g>
          <g filter="url(#glowCyan)">
            <path d="M86 28 L94 33 L94 43 L86 48 L78 43 L78 33 Z" fill="url(#cyanGrad)" opacity="0.75"/>
          </g>
          <g filter="url(#glowCyan)">
            <path d="M86 72 L94 77 L94 87 L86 92 L78 87 L78 77 Z" fill="url(#cyanGrad)" opacity="0.75"/>
          </g>
          <g filter="url(#glowIndigo)">
            <path d="M60 92 L68 97 L68 107 L60 112 L52 107 L52 97 Z" fill="url(#indigoGrad)" opacity="0.85"/>
          </g>
          <g filter="url(#glowIndigo)">
            <path d="M34 72 L42 77 L42 87 L34 92 L26 87 L26 77 Z" fill="url(#indigoGrad)" opacity="0.85"/>
          </g>
          <g filter="url(#glowCyan)">
            <path d="M34 28 L42 33 L42 43 L34 48 L26 43 L26 33 Z" fill="url(#cyanGrad)" opacity="0.75"/>
          </g>
          
          <!-- Connection lines -->
          <line x1="60" y1="28" x2="60" y2="40" stroke="#5D5DFF" stroke-width="1.5" stroke-dasharray="2,3" opacity="0.6"/>
          <line x1="78" y1="43" x2="68" y2="50" stroke="#00FFC2" stroke-width="1.5" stroke-dasharray="2,3" opacity="0.5"/>
          <line x1="78" y1="77" x2="68" y2="70" stroke="#00FFC2" stroke-width="1.5" stroke-dasharray="2,3" opacity="0.5"/>
          <line x1="60" y1="92" x2="60" y2="80" stroke="#5D5DFF" stroke-width="1.5" stroke-dasharray="2,3" opacity="0.6"/>
          <line x1="42" y1="77" x2="52" y2="70" stroke="#5D5DFF" stroke-width="1.5" stroke-dasharray="2,3" opacity="0.6"/>
          <line x1="42" y1="43" x2="52" y2="50" stroke="#00FFC2" stroke-width="1.5" stroke-dasharray="2,3" opacity="0.5"/>
          
          <!-- Central white circle -->
          <circle cx="60" cy="60" r="18" fill="#F2F2F2" opacity="0.98"/>
          <circle cx="60" cy="60" r="18" fill="none" stroke="#FFFFFF" stroke-width="2" opacity="0.5"/>
          
          <!-- Inner ring -->
          <circle cx="60" cy="60" r="22" fill="none" stroke="#5D5DFF" stroke-width="1.5" opacity="0.3"/>
          
          <!-- Connection nodes -->
          <circle cx="60" cy="8" r="2.5" fill="#5D5DFF" filter="url(#glowIndigo)"/>
          <circle cx="86" cy="28" r="2.5" fill="#00FFC2" filter="url(#glowCyan)"/>
          <circle cx="86" cy="92" r="2.5" fill="#00FFC2" filter="url(#glowCyan)"/>
          <circle cx="60" cy="112" r="2.5" fill="#5D5DFF" filter="url(#glowIndigo)"/>
          <circle cx="34" cy="92" r="2.5" fill="#5D5DFF" filter="url(#glowIndigo)"/>
          <circle cx="34" cy="28" r="2.5" fill="#00FFC2" filter="url(#glowCyan)"/>
        </svg>
        <span class="text-base md:text-xl font-bold text-color-accent hidden xs:inline" style="letter-spacing: 0.05em;">NYXOK</span>
        <span class="text-base md:text-xl font-bold text-color-accent xs:hidden" style="letter-spacing: 0.05em;">NYXOK</span>
      </a>

      <!-- Desktop Navigation -->
      <div class="hidden md:flex items-center gap-8" id="desktop-nav">
        {navItems.map((item) => (
          <a 
            href={item.href}
            data-nav-link
            data-nav-key={item.key}
            class="text-text-body hover:text-color-secondary transition-colors font-medium focus-visible:outline-2 focus-visible:outline-color-accent rounded px-2 py-1"
          >
            {t(item.key)}
          </a>
        ))}
      </div>

      <!-- Mobile Navigation (Shared Elements) -->
      <nav class="fixed inset-0 z-[60] pointer-events-none opacity-0" id="mobile-nav" aria-hidden="true" role="dialog" aria-label="Mobile navigation">
        <!-- Backdrop -->
        <div class="absolute inset-0 bg-black/80 backdrop-blur-xl opacity-0 transition-opacity duration-500" id="nav-backdrop"></div>
        
        <!-- Menu Content -->
        <div class="relative h-full flex flex-col items-center justify-center p-8 overflow-hidden">
          <!-- Background Effects -->
          <div class="absolute inset-0 overflow-hidden opacity-30">
            <div class="absolute top-1/4 right-1/4 w-64 h-64 bg-cyan-400/30 rounded-full blur-3xl animate-pulse-slow"></div>
            <div class="absolute bottom-1/4 left-1/4 w-64 h-64 bg-purple-400/30 rounded-full blur-3xl animate-pulse-slow" style="animation-delay: 1s;"></div>
          </div>

          <!-- Close Button -->
          <button
            id="menu-close-btn"
            class="absolute top-6 right-6 w-12 h-12 flex items-center justify-center rounded-full hover:bg-white/10 transition-colors focus-visible:outline-2 focus-visible:outline-brand-accent z-10"
            aria-label="Close navigation menu"
            type="button"
          >
            <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>

          <!-- Morphing Navigation Links Container -->
          <div class="relative z-10 flex flex-col items-center gap-8 w-full max-w-md" id="morphing-nav-container"></div>

          <!-- Language & CTA -->
          <div class="relative z-10 mt-12 flex flex-col items-center gap-6 opacity-0 transition-opacity duration-500" id="nav-footer">
            <div class="flex gap-4" role="group" aria-label="Language selection">
              <a
                href="/"
                class={`px-6 py-3 rounded-lg text-lg font-medium transition-all ${lang === 'en' ? 'bg-cyan-400 text-black' : 'text-white border border-white/20 hover:border-cyan-400'}`}
                aria-label="Switch to English"
              >
                EN
              </a>
              <a
                href="/es"
                class={`px-6 py-3 rounded-lg text-lg font-medium transition-all ${lang === 'es' ? 'bg-cyan-400 text-black' : 'text-white border border-white/20 hover:border-cyan-400'}`}
                aria-label="Cambiar a Español"
              >
                ES
              </a>
            </div>
            <a
              href="#demo"
              class="px-8 py-4 bg-gradient-to-r from-cyan-400 to-blue-500 text-black font-bold rounded-lg hover:shadow-lg hover:shadow-cyan-400/50 transition-all duration-300 focus-visible:outline-2 focus-visible:outline-offset-4 focus-visible:outline-cyan-400"
            >
              {t('nav.demo')}
            </a>
          </div>
        </div>
      </nav>

      <!-- Actions -->
      <div class="flex items-center gap-1.5 md:gap-3">
        <!-- Language Selector - Desktop -->
        <div class="hidden md:flex gap-1 md:gap-2" role="group" aria-label="Language selection">
          <a 
            href="/" 
            class={`px-2 md:px-3 py-1 md:py-1.5 rounded-md text-sm font-medium transition-all ${lang === 'en' ? 'bg-color-accent text-white shadow-sm' : 'text-text-muted hover:text-text-heading hover:bg-color-surface'}`}
            aria-label="Switch to English"
            aria-current={lang === 'en' ? 'true' : undefined}
          >
            EN
          </a>
          <a 
            href="/es" 
            class={`px-2 md:px-3 py-1 md:py-1.5 rounded-md text-sm font-medium transition-all ${lang === 'es' ? 'bg-color-accent text-white shadow-sm' : 'text-text-muted hover:text-text-heading hover:bg-color-surface'}`}
            aria-label="Cambiar a Español"
            aria-current={lang === 'es' ? 'true' : undefined}
          >
            ES
          </a>
        </div>
        <Button variant="primary" size="sm" href="#demo" ariaLabel={t('nav.demo')} class="hidden md:inline-flex text-xs md:text-sm px-3 md:px-4">
          <span class="hidden sm:inline">{t('nav.demo')}</span>
          <span class="sm:hidden">Demo</span>
        </Button>
        
        <!-- Hamburger Button -->
        <button
          id="hamburger-btn"
          class="md:hidden flex items-center justify-center w-10 h-10 rounded-lg hover:bg-white/5 transition-colors focus-visible:outline-2 focus-visible:outline-brand-accent"
          aria-label="Toggle navigation menu"
          aria-expanded="false"
          aria-controls="mobile-nav"
          type="button"
        >
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path class="hamburger-line hamburger-line-top" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16" />
            <path class="hamburger-line hamburger-line-middle" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 12h16" />
            <path class="hamburger-line hamburger-line-bottom" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 18h16" />
          </svg>
        </button>
      </div>
    </nav>
  </div>
</header>

<!-- Skip to main content link for accessibility -->
<a 
  href="#main-content" 
  class="sr-only focus:not-sr-only focus:absolute focus:top-4 focus:left-4 bg-brand-primary text-white px-4 py-2 rounded-lg z-[100] focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-brand-accent"
>
  Skip to main content
</a>

<style>
  /* Hamburger Icon Animation */
  .hamburger-line {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    transform-origin: center;
  }

  [aria-expanded="true"] .hamburger-line-top {
    transform: translateY(6px) rotate(45deg);
  }

  [aria-expanded="true"] .hamburger-line-middle {
    opacity: 0;
    transform: scaleX(0);
  }

  [aria-expanded="true"] .hamburger-line-bottom {
    transform: translateY(-6px) rotate(-45deg);
  }

  /* Morphing navigation links */
  .morphing-nav-link {
    position: fixed;
    text-decoration: none;
    font-weight: 700;
    color: white;
    text-shadow: 0 0 20px rgba(0, 255, 194, 0);
    transition: text-shadow 0.3s ease;
    z-index: 61;
    white-space: nowrap;
  }

  .morphing-nav-link:hover {
    color: #00FFC2;
    text-shadow: 0 0 20px rgba(0, 255, 194, 0.6);
  }

  .morphing-nav-link.morphing {
    pointer-events: none;
  }

  /* Letter morphing animation */
  .letter-morph {
    display: inline-block;
    transition: all 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .letter-morph.animating {
    opacity: 0;
    transform: translateY(20px) scale(0.8) rotate(-5deg);
    filter: blur(4px);
  }

  /* Reduced Motion */
  @media (prefers-reduced-motion: reduce) {
    .hamburger-line,
    .morphing-nav-link,
    .letter-morph {
      transition: opacity 0.2s ease !important;
    }

    .letter-morph {
      transform: none !important;
      filter: none !important;
    }
  }
</style>

<script>
  // Shared-Element Hamburger Menu with FLIP Animation
  class SharedElementMenu {
    private isOpen = false;
    private mobileNav: HTMLElement;
    private backdrop: HTMLElement;
    private hamburgerBtn: HTMLButtonElement;
    private closeBtn: HTMLButtonElement;
    private desktopNav: HTMLElement;
    private navLinks: NodeListOf<HTMLAnchorElement>;
    private morphingContainer: HTMLElement;
    private navFooter: HTMLElement;
    private clonedLinks: HTMLAnchorElement[] = [];
    private scrollY = 0;
    private prefersReducedMotion: boolean;

    constructor() {
      this.mobileNav = document.getElementById('mobile-nav') as HTMLElement;
      this.backdrop = document.getElementById('nav-backdrop') as HTMLElement;
      this.hamburgerBtn = document.getElementById('hamburger-btn') as HTMLButtonElement;
      this.closeBtn = document.getElementById('menu-close-btn') as HTMLButtonElement;
      this.desktopNav = document.getElementById('desktop-nav') as HTMLElement;
      this.navLinks = document.querySelectorAll('[data-nav-link]');
      this.morphingContainer = document.getElementById('morphing-nav-container') as HTMLElement;
      this.navFooter = document.getElementById('nav-footer') as HTMLElement;
      this.prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      this.init();
    }

    private init() {
      this.hamburgerBtn.addEventListener('click', () => this.toggle());
      this.closeBtn.addEventListener('click', () => this.close());
      this.backdrop.addEventListener('click', () => this.close());
      document.addEventListener('keydown', (e) => this.handleKeyDown(e));

      // Listen for reduced motion changes
      const motionQuery = window.matchMedia('(prefers-reduced-motion: reduce)');
      motionQuery.addEventListener('change', (e) => {
        this.prefersReducedMotion = e.matches;
      });
    }

    private async toggle() {
      if (this.isOpen) {
        await this.close();
      } else {
        await this.open();
      }
    }

    private async open() {
      this.isOpen = true;
      
      // Update ARIA
      this.hamburgerBtn.setAttribute('aria-expanded', 'true');
      this.mobileNav.setAttribute('aria-hidden', 'false');

      // Preserve scroll position
      this.scrollY = window.scrollY;
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.top = `-${this.scrollY}px`;
      document.body.style.width = '100%';

      // Show mobile nav
      this.mobileNav.classList.remove('pointer-events-none', 'opacity-0');
      this.mobileNav.classList.add('pointer-events-auto', 'opacity-100');

      // Animate backdrop
      requestAnimationFrame(() => {
        this.backdrop.style.opacity = '1';
      });

      // Clone and morph links using FLIP
      await this.morphLinksToFullscreen();

      // Show footer
      setTimeout(() => {
        this.navFooter.style.opacity = '1';
      }, this.prefersReducedMotion ? 100 : 400);

      // Focus close button
      setTimeout(() => {
        this.closeBtn.focus();
      }, 100);
    }

    private async morphLinksToFullscreen() {
      // Clear previous clones
      this.morphingContainer.innerHTML = '';
      this.clonedLinks = [];

      this.navLinks.forEach((link, index) => {
        // FLIP - First: Record initial position
        const firstRect = link.getBoundingClientRect();
        const linkText = link.textContent || '';

        // Create morphing clone
        const clone = document.createElement('a');
        clone.href = link.getAttribute('href') || '#';
        clone.className = 'morphing-nav-link morphing';
        clone.textContent = '';

        // Split text into letters
        linkText.split('').forEach((char, charIndex) => {
          const span = document.createElement('span');
          span.className = 'letter-morph animating';
          span.textContent = char === ' ' ? '\u00A0' : char;
          span.style.transitionDelay = `${index * 0.05 + charIndex * 0.02}s`;
          clone.appendChild(span);
        });

        // Position clone at original location
        clone.style.left = `${firstRect.left}px`;
        clone.style.top = `${firstRect.top}px`;
        clone.style.fontSize = window.getComputedStyle(link).fontSize;
        
        document.body.appendChild(clone);
        this.clonedLinks.push(clone);

        // FLIP - Last: Calculate target position (center of screen)
        const targetTop = window.innerHeight / 2 - 150 + index * 100;
        const targetLeft = window.innerWidth / 2;

        // FLIP - Invert & Play: Animate to target
        requestAnimationFrame(() => {
          clone.classList.remove('morphing');
          clone.style.transition = this.prefersReducedMotion 
            ? 'all 0.3s ease'
            : 'all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1)';
          clone.style.left = `${targetLeft}px`;
          clone.style.top = `${targetTop}px`;
          clone.style.transform = 'translateX(-50%)';
          clone.style.fontSize = '3rem';

          // Animate letters
          const letters = clone.querySelectorAll('.letter-morph');
          letters.forEach((letter) => {
            (letter as HTMLElement).classList.remove('animating');
          });
        });

        // Add click handler
        clone.addEventListener('click', (e) => {
          e.preventDefault();
          this.close().then(() => {
            window.location.href = clone.href;
          });
        });
      });
    }

    private async close() {
      if (!this.isOpen) return;
      
      this.isOpen = false;

      // Update ARIA
      this.hamburgerBtn.setAttribute('aria-expanded', 'false');
      this.mobileNav.setAttribute('aria-hidden', 'true');

      // Hide footer
      this.navFooter.style.opacity = '0';

      // Animate backdrop
      this.backdrop.style.opacity = '0';

      // Morph links back to original position
      await this.morphLinksToOriginal();

      // Wait for animation
      const duration = this.prefersReducedMotion ? 300 : 800;
      await new Promise(resolve => setTimeout(resolve, duration));

      // Hide mobile nav
      this.mobileNav.classList.add('pointer-events-none', 'opacity-0');
      this.mobileNav.classList.remove('pointer-events-auto', 'opacity-100');

      // Restore scroll
      document.body.style.overflow = '';
      document.body.style.position = '';
      document.body.style.top = '';
      document.body.style.width = '';
      window.scrollTo(0, this.scrollY);

      // Restore focus
      this.hamburgerBtn.focus();
    }

    private async morphLinksToOriginal() {
      this.navLinks.forEach((link, index) => {
        const clone = this.clonedLinks[index];
        if (!clone) return;

        const firstRect = link.getBoundingClientRect();

        // Animate letters out
        const letters = clone.querySelectorAll('.letter-morph');
        letters.forEach((letter) => {
          (letter as HTMLElement).classList.add('animating');
        });

        // Animate back to original position
        clone.style.left = `${firstRect.left}px`;
        clone.style.top = `${firstRect.top}px`;
        clone.style.transform = 'none';
        clone.style.fontSize = window.getComputedStyle(link).fontSize;
      });

      // Remove clones after animation
      setTimeout(() => {
        this.clonedLinks.forEach(clone => clone.remove());
        this.clonedLinks = [];
      }, this.prefersReducedMotion ? 300 : 800);
    }

    private handleKeyDown(e: KeyboardEvent) {
      if (!this.isOpen) return;

      if (e.key === 'Escape') {
        e.preventDefault();
        this.close();
      }
    }
  }

  // Initialize
  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', () => {
      new SharedElementMenu();
    });
  }
</script>
